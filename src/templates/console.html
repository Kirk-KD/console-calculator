{% extends "base.html" %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/console.css') }}">
{% endblock %}

{% block body %}
<div class="main-container">
    <div class="ms-alert ms-border console-container">
        <div class="console-element">
            <div class="only-text">
                <hr>
                Enter a math expression or a command and press <code>Enter</code>.
                Type <code>help</code> to get a detailed list of commands with descriptions.

                <div class="small-header">Auto Completion</div>
                Press <code>Tap</code> to auto complete a selected command name.
                Use <code>Up</code>/<code>Down</code> to select a command from the suggestion list.
                Or click a command if you really want to use your mouse.

                <div class="small-header">Command History</div>
                Use <code>Ctrl</code> + <code>Up</code>/<code>Down</code> to navigate through your past commands.
            </div>
        </div>
    </div>
    <div class="command-input-container">
        <div class="command-input math" tabindex="0">
            <span class="ci-root-cursor ci-has-cursor"><span class="ci-cursor">&#8203</span></span>
        </div>
        <div class="ms-loading loading-indicator"></div>
    </div>
    <div class="ac-suggestions"></div>
    <div class="command-description"></div>
</div>

<footer>
    <p>Copyright - All rights reserved - &copy;<b>Kirk_KD</b> - <a href="https://github.com/Kirk-KD/console-calculator">Github</a></p>
</footer>

<script>
    (() => {
        var commandHistory = [];
        var historyIndex = 0;
        var acSelectionIndex = -1;

        const IS_CMD_REGEX = /[a-z_]/i;

        /*
        CI_CURSOR should be used as a child of a non-container ci-type such as
        a ci-digit, and NOT a ci-superscript. The purpose of CI_CURSOR is only
        to display the blinking cursor correctly.
        */
        const CI_CURSOR = `<span class="ci-cursor">&#8203</span>`;

        const UPPER_ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const LOWER_ALPHA = UPPER_ALPHA.toLowerCase();
        const NUM_CHARS = "0123456789.";
        const OPERATORS = "+-*/";
        const CONVERTED_OPERATORS = "+−×÷";

        $(".ac-suggestions").hide();
        $(".loading-indicator").hide();

        var commandsInfo;
        var helpHTML;
        $.post({
            url: "/load_commands",
            async: false // blocking because must get `commandsInfo` for other code to work
        }).done(response => {
            commandsInfo = response;

            // generate HTML for help command
            let helpHTMLs = [];
            for (const [name, command] of Object.entries(commandsInfo)) {
                helpHTMLs.push(command.helpHTML);
            }
            helpHTML = `<div class="console-element">
                            <div class="only-text help-msg">
                                <hr>
                                ${helpHTMLs.join("<br><br>")}
                            </div>
                        </div>`;
        });
        
        function searchCommands(query, limit) {
            let results = {};

            for (const [name, detail] of Object.entries(commandsInfo)) {
                if (name.startsWith(query)) {
                    results[name] = detail.parsedArgs;
                    if (Object.keys(results).length == limit) break;
                }
            }

            return results;
        }

        function parseInput(input) {
            /*
            Parse console input into a command and arguments list, or
            into a math expression.
            */

            let inputCleaned = input.trim().toLowerCase();
            let inputSplit = inputCleaned.split(" ");

            let command = inputSplit[0];
            if (IS_CMD_REGEX.test(command) || input === "") {
                let argumentsText = inputSplit.length > 1 ?
                                    inputSplit.slice(1).join(" ") :
                                    "";

                let arguments = argumentsText.split(",")
                for (let i = 0; i < arguments.length; i++)
                    arguments[i] = arguments[i].trim();

                return {commandName: command, arguments: arguments[0] == "" ? [] : arguments};
            } else {
                return {expr: inputCleaned};
            }
        }

        function makeCommandResultElement(response) {
            return `<div class="console-element">
                        <hr>
                        <div class="original-command math">
                            <span class="command-name">${response.commandName}</span> ${response.parsedArgs}
                        </div>
                        <span class="command-result math">${response.commandResult}</span>
                    </div>`;
        }

        function makeEvalResultElement(response) {
            return `<div class="console-element">
                        <hr>
                        <div class="original-expr math">${response.originalExpr}</div>
                        <span class="command-result math">${response.result}</span>
                    </div>`
        }

        function makeAutocompleteItems(searchResults) {
            let result = "";
            for (const [name, parsedArgs] of Object.entries(searchResults)) {
                result = `<div class="ac-suggestion-item" command-name="${name}">${name} 
                    <span class="ac-args">${parsedArgs}</span></div>` + result;
            }
            return result;
        }

        function updateAutocomplete(commandName) {
            let searchResults = searchCommands(commandName, 10);
            let resultsLength = Object.keys(searchResults).length;
            if (resultsLength > 0) {
                $(".ac-suggestions").html(makeAutocompleteItems(searchResults)).show();
                acSelectionIndex = resultsLength - 1;
                $(".ac-suggestions").children()[acSelectionIndex].id = "ac-suggestion-item-selected";
                updateDescription();
            } else {
                $(".ac-suggestions").hide();
                $(".command-description").html("");
                acSelectionIndex = -1;
            }
        }

        function updateDescription() {
            let commandName = $("#ac-suggestion-item-selected").attr("command-name");
            $(".command-description").html(commandsInfo[commandName].description || "");
        }

        function replaceMath(input) {
            switch (input) {
                case "-": return "−"
                case "*": return "×"
                case "/": return "÷"
                default: return input
            }
        }

        function undoReplaceMath(input) {
            switch (input) {
                case "−": return "-"
                case "×": return "*"
                case "÷": return "/"
                default: return input
            }
        }

        function generateMathHTML(input) {

        }

        function addCursor(jquery) {
            /* Adds a cursor to the end of a ci <span>. */

            let children = jquery.children();

            if (!children.last().hasClass("ci-cursor")) {
                jquery.append(CI_CURSOR).addClass("ci-has-cursor");
            }
        }

        function removeCursor(jquery) {
            /* Removes a cursor from a ci <span>. */
            
            let children = jquery.children();

            if (children.last().hasClass("ci-cursor")) {
                children.last().remove();
                jquery.removeClass("ci-has-cursor");
            }
        }

        function getText(jquery) {
            /* Gets the text and not the children elements of a jquery. */

            return jquery[0].childNodes[0] ? jquery[0].childNodes[0].nodeValue : "";
        }

        function commandInputToString(jquery) {
            /*
            Gets the content of command-input and parse it to pass 
            to the backend to be processed.

            `jquery`:
                the command-input or a child element to be parsed to 
                string recursively.    
            */

            let result = "";

            jquery.children().each(function() {
                let child = $(this);
                if (
                    child.hasClass("ci-digit") ||
                    child.hasClass("ci-letter")
                ) result += getText(child);
                else if (
                    child.hasClass("ci-binary-op") ||
                    child.hasClass("ci-unary-op")
                ) result += undoReplaceMath(getText(child));
                else if (child.hasClass("ci-space")) result += " ";
                else if (child.hasClass("ci-comma")) result += ",";
                else if (child.hasClass("ci-superscript"))
                    result += `**(${commandInputToString(child)})`;
            });

            return result;
        }

        // Show autocomplete items when autofocused/loaded
        updateAutocomplete("");

        $(".ac-suggestions").on("click", ".ac-suggestion-item", e => {
            let commandName = e.target.getAttribute("command-name");
            $(".command-input").focus().val(commandName);
            updateAutocomplete(commandName);
        });

        $(".command-input").on("click", e => {
            e.target.focus();

            let jElem = $(e.target);
            if (jElem.hasClass("command-input")) {
                let mouseX = e.pageX;
                let firstChild = jElem.children().first();
                let lastChild = jElem.children().last();

                if (mouseX < firstChild.offset().left) {
                    removeCursor($(".ci-has-cursor"));
                    addCursor(firstChild);
                } else if (mouseX > lastChild.offset().left + lastChild.width()) {
                    removeCursor($(".ci-has-cursor"));
                    addCursor(lastChild);
                }
            }
        }).on("click", ".ci-clickable", e => {
            let jElem = $(e.target);
            if (jElem.hasClass("ci-clickable")) {
                removeCursor($(".ci-has-cursor"));

                let mouseX = e.pageX - jElem.offset().left;
                let elemWidth = jElem.width();
                if (mouseX < elemWidth / 2) addCursor(jElem.prev());
                else addCursor(jElem);
            }
        }).on("keydown", e => {
            let selector = $(".command-input");
            let cursorSelector = $(".ci-has-cursor");

            if (e.key.length === 1) {
                // math expressions
                if (NUM_CHARS.includes(e.key)) { // Single digit
                    if (!cursorSelector.hasClass("ci-letter")) {
                        removeCursor(cursorSelector);
                        cursorSelector.after(
                            `<span class="ci-clickable ci-digit ci-has-cursor">${e.key}${CI_CURSOR}</span>`
                        );
                    }
                } else if (OPERATORS.includes(e.key)) { // Binary and Unary operators
                    removeCursor(cursorSelector);

                    // the current + or - sign is an unary operator
                    if ((e.key === "+" || e.key === "-") &&
                        (CONVERTED_OPERATORS.includes(getText(cursorSelector))
                        || getText(cursorSelector) === ""))
                        cursorSelector.after(
                            `<span class="ci-clickable ci-unary-op ci-has-cursor">${replaceMath(e.key)}${CI_CURSOR}</span>`
                        );
                    else {
                        cursorSelector.after(
                            `<span class="ci-clickable ci-binary-op ci-has-cursor">${replaceMath(e.key)}${CI_CURSOR}</span>`
                        );
                    }
                } else if (e.key === "^" && (NUM_CHARS + "()").includes(getText(cursorSelector))) { // Exponent
                    removeCursor(cursorSelector);
                    cursorSelector.after(
                        `<span class="ci-superscript"><span class="ci-section-root-cursor ci-has-cursor">${CI_CURSOR}</span></span>`
                    );
                }

                // commands
                else if ((UPPER_ALPHA + LOWER_ALPHA + "_").includes(e.key)) {
                    removeCursor(cursorSelector);
                    cursorSelector.after(
                        `<span class="ci-clickable ci-letter ci-has-cursor">${e.key}${CI_CURSOR}</span>`
                    );
                } else if (e.key === " ") {
                    if ( // inputting command name
                        selector.children().last().hasClass("ci-letter") &&
                        cursorSelector.hasClass("ci-letter") &&
                        !selector.attr("has-command-name")
                    ) {
                        removeCursor(cursorSelector);
                        cursorSelector.after(
                            `<span class="ci-clickable ci-space ci-has-cursor">&ensp;${CI_CURSOR}</span>`
                        );
                        selector.attr("has-command-name", "true");
                    }
                } else if (e.key === ",") {
                    if(
                        selector.attr("has-command-name") &&
                        !cursorSelector.hasClass("ci-space") &&
                        !cursorSelector.hasClass("ci-comma") &&
                        !cursorSelector.hasClass("ci-letter") &&
                        !cursorSelector.next().hasClass("ci-space") &&
                        !cursorSelector.next().hasClass("ci-comma") &&
                        !cursorSelector.next().hasClass("ci-letter")
                    ) {
                        removeCursor(cursorSelector);
                        cursorSelector.after(
                            `<span class="ci-clickable ci-comma ci-has-cursor">,&ensp;${CI_CURSOR}</span>`
                        );
                    }
                }
            } else if (e.key === "Backspace") {
                // cursor is not at the very beginning of the input
                if (!cursorSelector.hasClass("ci-root-cursor")) {
                    // cursor was at the beginning of a superscript
                    if (cursorSelector.hasClass("ci-section-root-cursor")) {
                        // move cursor outside of the superscript and add cursor
                        addCursor(cursorSelector.parent().prev());
                        cursorSelector.parent().remove();
                    } else if (cursorSelector.hasClass("ci-space")) {
                        selector.attr("has-command-name", "");
                        addCursor(cursorSelector.prev());
                    } else if (cursorSelector.prev().hasClass("ci-superscript")) {
                        addCursor(cursorSelector.prev().children().last());
                    } else addCursor(cursorSelector.prev());

                    cursorSelector.remove();
                }
                console.log($(".ci-has-cursor"));
            } else if (e.key === "Enter") {
                console.log(commandInputToString(selector));
            }
        });
    })();
</script>
{% endblock %}