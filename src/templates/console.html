{% extends "base.html" %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/console.css') }}">
{% endblock %}

{% block body %}
<div class="main-container">
    <div class="ms-alert ms-border console-container"></div>
    <input type="text" id="command-input" class="command-input" autofocus>
    <div class="ac-suggestions"></div>
</div>

<script>
    (() => {
        var commandHistory = [];
        var historyIndex = 0;
        var acSelectionIndex = -1;

        $(".ac-suggestions").hide();

        function parseInput(input) {
            /* Parse console input into a command and arguments list. */

            let inputSplit = input.trim().split(" ");

            let command = inputSplit[0];
            let argumentsText = inputSplit.length > 1 ?
                                inputSplit.slice(1).join(" ") :
                                "";

            let arguments = argumentsText.split(",")
            for (let i = 0; i < arguments.length; i++)
                arguments[i] = arguments[i].trim().toLowerCase();

            return {commandName: command, arguments: arguments[0] == "" ? [] : arguments};
        }

        function makeResultElement(response) {
            return `<div class="console-element">
                        <hr>
                        <div class="original-command math">
                            <span class="command-name">${response.commandName}</span> ${response.parsedArgs}
                        </div>
                        <span class="command-result math">${response.commandResult}</span>
                    </div>`;
        }

        function makeAutocompleteItems(response) {
            let result = "";
            for (const [name, args_text] of Object.entries(response.commands)) {
                result = `<div class="ac-suggestion-item" command-name="${name}">${name} <span class="ac-args">${args_text}</span></div>` + result;
            }
            return result;
        }

        function updateAutocomplete(commandName) {
            $.post({
                url: "/search",
                data: `{"query": "${commandName}"}`,
                contentType: "application/json;"
            }).done(response => {
                if (!response.isEmpty) {
                    $(".ac-suggestions").html(makeAutocompleteItems(response)).show();
                    acSelectionIndex = Object.keys(response.commands).length - 1;
                    $(".ac-suggestions").children()[acSelectionIndex].id = "ac-suggestion-item-selected";
                } else {
                    $(".ac-suggestions").hide();
                    acSelectionIndex = -1;
                }
            });
        }

        $("#command-input").on("input", e => {
            let {commandName, arguments} = parseInput(e.target.value);
            updateAutocomplete(commandName);
        }).on("keydown", e => {
            if (["Enter", "ArrowUp", "ArrowDown", "Tab"].indexOf(e.key) > -1) e.preventDefault();
            if (e.key === "Enter") {
                if (e.target.value.trim().length > 0) {
                    let commandData = JSON.stringify(parseInput(e.target.value));

                    $.post({
                        url: "/calculate",
                        data: commandData,
                        contentType: "application/json;"
                    }).done(response => {
                        commandHistory.push(e.target.value);
                        
                        historyIndex = 0;
                        e.target.value = "";
                        $(".ac-suggestions").html("").hide();
                        
                        $(".console-container").prepend(makeResultElement(response));
                    });
                }
            } else if (e.ctrlKey && e.key === "ArrowUp") {
                if (commandHistory.length > 0 && commandHistory.length + historyIndex - 1 >= 0) {
                    historyIndex--;
                    e.target.value = commandHistory[commandHistory.length + historyIndex];
                }
            } else if (e.ctrlKey && e.key === "ArrowDown") {
                if (commandHistory.length > 0 && commandHistory.length + historyIndex + 1 < commandHistory.length) {
                    historyIndex++;
                    e.target.value = commandHistory[commandHistory.length + historyIndex];
                }
            } else if (e.key == "ArrowUp" && acSelectionIndex !== -1) {
                let children = $(".ac-suggestions").children();
                children[acSelectionIndex].removeAttribute("id");

                acSelectionIndex--;
                if (acSelectionIndex < 0) acSelectionIndex = children.length - 1;
                children[acSelectionIndex].id = "ac-suggestion-item-selected";
            } else if (e.key == "ArrowDown" && acSelectionIndex !== -1) {
                let children = $(".ac-suggestions").children();
                children[acSelectionIndex].removeAttribute("id");

                acSelectionIndex++;
                if (acSelectionIndex >= children.length) acSelectionIndex = 0;
                children[acSelectionIndex].id = "ac-suggestion-item-selected";
            } else if (e.key == "Tab" && acSelectionIndex !== -1) {
                let children = $(".ac-suggestions").children();
                let commandName = children[acSelectionIndex].getAttribute("command-name");
                e.target.value = commandName;
                updateAutocomplete(commandName);
            }
        });
    })();
</script>
{% endblock %}